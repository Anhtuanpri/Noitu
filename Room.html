<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ph√≤ng n·ªëi ch·ªØ</title>
<link rel="stylesheet" href="style.css">

<!-- üî• FIREBASE SDK v12 -->
<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set }
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDiv0nqf1Gse7sDxwVVon-LtL_kbkLYS3A",
  authDomain: "noitu-560ef.firebaseapp.com",
  databaseURL: "https://noitu-560ef-default-rtdb.firebaseio.com",
  projectId: "noitu-560ef"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== SETUP =====
const roomId = new URLSearchParams(location.search).get("room");
const user = localStorage.getItem("username") || "·∫®n danh";

const chatRef = ref(db, "rooms/" + roomId + "/chat");
const gameRef = ref(db, "rooms/" + roomId + "/game");

// ===== UI =====
const chatBox = document.getElementById("chat");
const input = document.getElementById("input");
const currentWord = document.getElementById("currentWord");

function addMsg(user, text, host=false){
  const div = document.createElement("div");
  div.className = "msg " + (host ? "host":"user");
  div.innerHTML = `<b>${user}</b><br>${text}`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ===== RECEIVE CHAT REALTIME =====
onChildAdded(chatRef, snap=>{
  const d = snap.val();
  addMsg(d.user, d.text, d.user==="HOST");
});

// ===== RECEIVE GAME STATE =====
onChildAdded(ref(db,"rooms/"+roomId+"/system"), snap=>{
  const d = snap.val();
  addMsg("HOST", d.text, true);
  if(d.currentWord) currentWord.innerText = d.currentWord;
});

// ===== SEND =====
window.send = function(){
  const text = input.value.trim();
  if(!text) return;
  input.value = "";

  // chat th∆∞·ªùng
  push(chatRef,{ user, text });

  // l·ªánh /start
  if(text.startsWith("/start")){
    const word = text.replace("/start","").trim();
    set(gameRef,{
      currentWord: word,
      lastUser: "HOST"
    });
    push(ref(db,"rooms/"+roomId+"/system"),{
      text:`üî• B·∫Øt ƒë·∫ßu v·ªõi t·ª´ "${word}"`,
      currentWord: word
    });
  }

  // ch∆°i n·ªëi ch·ªØ
  if(!text.startsWith("/")){
    set(gameRef,{
      currentWord: text,
      lastUser: user
    });
    push(ref(db,"rooms/"+roomId+"/system"),{
      text:`${user} n·ªëi: "${text}"`,
      currentWord: text
    });
  }
};
</script>
</head>

<body>
<div class="layout">
  <div class="header">
    üè† Ph√≤ng: <b id="roomName"></b>
  </div>

  <div class="word">
    T·ª´ hi·ªán t·∫°i: <span id="currentWord">---</span>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-row">
    <input id="input" placeholder="/start v√¨ | nh·∫≠p t·ª´ n·ªëi">
    <button onclick="send()">G·ª≠i</button>
  </div>
</div>

<script>
document.getElementById("roomName").innerText =
  new URLSearchParams(location.search).get("room");
</script>

</body>
</html>
