<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ná»‘i Tá»« GhÃ©p</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#1e0b4b,#020617);
  color:#e5e7eb;
}
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.glass{
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(16px);
  border-radius:20px;
  box-shadow:0 0 40px rgba(168,85,247,.5);
}
.login{
  width:380px;padding:26px;text-align:center
}
.login input, .login button{
  width:100%;margin:6px 0;padding:14px;
  border:none;border-radius:14px;font-weight:700
}
.login button{
  cursor:pointer;
  background:linear-gradient(135deg,#7c3aed,#22d3ee);
}
.room{
  max-width:640px;margin:0 auto;height:100vh;
  display:flex;flex-direction:column
}
.header{
  display:flex;justify-content:space-between;
  align-items:center;padding:12px;
  border-bottom:1px solid #334155
}
.header button{
  margin-left:6px;padding:6px 10px;
  border:none;border-radius:10px;
  font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,#22d3ee,#a855f7)
}
.chat{flex:1;overflow:auto;padding:14px}
.msg{
  margin:6px 0;padding:10px 14px;border-radius:14px
}
.system{background:#1e293b;color:#93c5fd}
.correct{background:#052e16;color:#4ade80}
.wrong{background:#450a0a;color:#fca5a5}
.bxh{background:#020617;color:#fde68a;border:1px dashed #facc15}
.input{
  display:flex;gap:8px;padding:12px;
  border-top:1px solid #334155
}
.input input{
  flex:1;padding:14px;border:none;border-radius:14px
}
.input button{
  padding:14px 18px;border:none;
  border-radius:14px;font-weight:800;
  background:#7c3aed;color:white
}
#toast{
  position:fixed;top:20px;right:20px;
  padding:12px 16px;border-radius:14px;
  font-weight:700;opacity:0;transition:.25s
}
#toast.show{opacity:1}
.toast-ok{background:#052e16;color:#4ade80}
.toast-bad{background:#450a0a;color:#f87171}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="glass login">
    <h2>ğŸ”® Ná»I Tá»ª GHÃ‰P</h2>
    <input id="nameInput" placeholder="TÃªn cá»§a báº¡n">
    <input id="hostInput" placeholder="MÃ£ host (náº¿u cÃ³)">
    <button onclick="enter()">VÃ€O PHÃ’NG</button>
    <p style="font-size:13px;color:#9ca3af">
      TÃªn Ä‘Æ°á»£c lÆ°u â€“ chá»‰ Ä‘á»•i khi xÃ³a lá»‹ch sá»­
    </p>
  </div>
</div>

<!-- POPUP CHá»ŒN MODE (CHá»ˆ HOST) -->
<div id="modePopup" class="center hidden">
  <div class="glass login">
    <h3>ğŸ® CHá»ŒN CHáº¾ Äá»˜</h3>
    <button onclick="startGame('list')">âš¡ LIST</button>
    <button onclick="startGame('gpt')">ğŸ¤– GPT</button>
  </div>
</div>

<!-- ROOM -->
<div id="room" class="room hidden">
  <div class="header">
    <span id="rootWord">...</span>
    <div>
      <button id="resetBtn" class="hidden" onclick="resetGame()">ğŸ”</button>
      <button onclick="copyLink()">ğŸ”—</button>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input">
    <input id="text" placeholder="Nháº­p tá»« ghÃ©p">
    <button onclick="send()">Gá»¬I</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
/* ================= CONFIG ================= */
const HOST_CODE = "1.2991.22283.33";
const OPENAI_API_KEY = "sk-XXXXXXXXXXXXXXXXXXXXXXXX";

const WORD_LIST = [
  "tá»• quá»‘c","quá»‘c gia","gia Ä‘Ã¬nh","Ä‘Ã¬nh lÃ ng",
  "lÃ ng quÃª","quÃª hÆ°Æ¡ng","hÆ°Æ¡ng sáº¯c","sáº¯c Ä‘áº¹p",
  "Ä‘áº¹p ngÆ°á»i","ngÆ°á»i dÃ¢n","dÃ¢n tá»™c","tá»™c ngÆ°á»i"
];

/* ================= FIREBASE ================= */
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getDatabase, ref, get, set, update,
  push, onChildAdded, onValue
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const params = new URLSearchParams(location.search);
const roomId = params.get("room") || "phong-chung";

const firebaseConfig = {
  apiKey:"AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  authDomain:"noitu-7dca6.firebaseapp.com",
  databaseURL:"https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"noitu-7dca6",
  messagingSenderId:"253854569418",
  appId:"1:253854569418:web:105e8e3edfdd9baafff533"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const stateRef = ref(db,`rooms/${roomId}/state`);
const chatRef  = ref(db,`rooms/${roomId}/chat`);
const playersRef = ref(db,`rooms/${roomId}/players`);

/* ================= STATE ================= */
let name = "";
let isHost = false;
let eliminated = false;

/* ================= UI ================= */
const toast = document.getElementById("toast");
function notify(msg, ok=true){
  toast.textContent = msg;
  toast.className = "show " + (ok?"toast-ok":"toast-bad");
  setTimeout(()=>toast.className="",1200);
}
function add(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ================= LOGIN ================= */
const saved = localStorage.getItem("noitu_name");
if(saved) nameInput.value = saved;

window.enter = async ()=>{
  name = nameInput.value.trim();
  if(!name) return;
  localStorage.setItem("noitu_name", name);

  isHost = hostInput.value.trim() === HOST_CODE;
  if(isHost){
    resetBtn.classList.remove("hidden");
  }

  await update(ref(db,`rooms/${roomId}/players/${name}`),{
    alive:true,score:0
  });

  login.classList.add("hidden");
  room.classList.remove("hidden");

  const snap = await get(stateRef);
  if(snap.exists()){
    rootWord.textContent = "Gá»‘c: " + snap.val().root;
  }else{
    if(isHost){
      modePopup.classList.remove("hidden");
    }else{
      rootWord.textContent = "â³ Äang chá» host...";
    }
  }
};

/* ================= START GAME (HOST) ================= */
window.startGame = async (mode)=>{
  if(!isHost) return;
  const root = WORD_LIST[0].split(" ")[0];
  await set(stateRef,{
    root,
    mode,
    status:"playing"
  });
  modePopup.classList.add("hidden");
};

/* ================= STATE SYNC ================= */
onValue(stateRef,snap=>{
  if(!snap.exists()) return;
  rootWord.textContent = "Gá»‘c: " + snap.val().root;
});

/* ================= CHAT ================= */
onChildAdded(chatRef,s=>add(s.val().text,s.val().cls));

/* ================= CHECKERS ================= */
function checkByList(root,word){
  const ok = WORD_LIST.find(w=>w===word && w.startsWith(root+" "));
  return ok ? word.split(" ").pop() : null;
}

async function checkByGPT(root,word){
  const r = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"Báº¡n lÃ  trá»ng tÃ i ná»‘i tá»« ghÃ©p tiáº¿ng Viá»‡t."},
        {role:"user",content:
`Tá»« gá»‘c: "${root}"
NgÆ°á»i chÆ¡i: "${word}"
Tráº£ JSON {"valid":true,"next":"tá»«"} hoáº·c {"valid":false}`}
      ],
      temperature:0,max_tokens:60
    })
  });
  const j = await r.json();
  return JSON.parse(j.choices[0].message.content);
}

/* ================= GAME LOGIC ================= */
async function checkWinner(){
  const snap = await get(playersRef);
  const ps = snap.val();
  const alive = Object.keys(ps).filter(p=>ps[p].alive);
  if(alive.length===1){
    push(chatRef,{text:`ğŸ† ${alive[0]} CHIáº¾N THáº®NG!`,cls:"system"});
    await update(stateRef,{status:"ended"});
  }
}

window.send = async ()=>{
  if(eliminated) return notify("Báº¡n Ä‘Ã£ bá»‹ loáº¡i",false);

  const val = text.value.trim().toLowerCase();
  if(!val) return;
  text.value="";

  const st = (await get(stateRef)).val();
  if(!st || st.status!=="playing") return;

  try{
    let next;
    if(st.mode==="list"){
      next = checkByList(st.root,val);
      if(!next) throw "sai";
    }else{
      const rs = await checkByGPT(st.root,val);
      if(!rs.valid) throw "sai";
      next = rs.next;
    }

    await update(stateRef,{root:next});
    push(chatRef,{text:`âœ… ${name}: ${val}`,cls:"correct"});
    await checkWinner();

  }catch{
    eliminated = true;
    await update(ref(db,`rooms/${roomId}/players/${name}`),{alive:false});
    push(chatRef,{text:`âŒ ${name} bá»‹ loáº¡i`,cls:"wrong"});
    await checkWinner();
  }
};

window.resetGame = async ()=>{
  if(!isHost) return;
  await set(ref(db,`rooms/${roomId}`),null);
  location.reload();
};

window.copyLink = ()=>{
  navigator.clipboard.writeText(
    location.origin+location.pathname+"?room="+roomId
  );
  notify("ÄÃ£ copy link");
};
</script>

</body>
</html>
