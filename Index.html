<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ná»‘i Tá»« GhÃ©p</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#020617,#120029);
  color:#e5e7eb;
}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.card{
  width:380px;padding:24px;border-radius:18px;
  background:rgba(255,255,255,.07);
  backdrop-filter:blur(14px);
  box-shadow:0 0 30px rgba(139,92,246,.4);
  text-align:center;
}
.room{
  max-width:600px;margin:0 auto;height:100vh;
  display:flex;flex-direction:column;
}
.header{
  padding:12px;border-bottom:1px solid #334155;
  display:flex;justify-content:space-between;align-items:center;
  color:#c4b5fd;
}
.header button{
  background:linear-gradient(135deg,#22d3ee,#a855f7);
  border:none;border-radius:12px;
  padding:6px 10px;font-weight:700;
  cursor:pointer;
}
.chat{flex:1;overflow:auto;padding:12px}
.msg{
  margin:6px 0;padding:10px 14px;border-radius:14px;
}
.system{background:#1e293b;color:#93c5fd}
.correct{background:#052e16;color:#4ade80}
.wrong{background:#450a0a;color:#f87171}
.bxh{background:#020617;color:#fde68a;border:1px dashed #facc15}
.input-row{
  display:flex;gap:8px;padding:10px;
  border-top:1px solid #334155;
}
input{flex:1;padding:12px;border:none;border-radius:10px}
button.send{
  padding:12px 16px;border:none;border-radius:10px;
  background:#7c3aed;color:#fff;font-weight:700;
}
.hidden{display:none}

/* toast */
#toast{
  position:fixed;top:20px;right:20px;
  padding:10px 14px;border-radius:12px;
  font-weight:700;opacity:0;transition:.25s;
}
#toast.show{opacity:1}
.toast-ok{background:#052e16;color:#4ade80}
.toast-bad{background:#450a0a;color:#f87171}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card">
    <h2>ğŸ”— Ná»‘i Tá»« GhÃ©p</h2>
    <input id="nameInput" placeholder="TÃªn cá»§a báº¡n">
    <input id="hostInput" placeholder="MÃ£ host (náº¿u cÃ³)">
    <button onclick="enter()">VÃ o phÃ²ng</button>
    <p style="font-size:13px;color:#aaa">
      Nháº­p mÃ£ Ä‘á»ƒ lÃ m host
    </p>
  </div>
</div>

<!-- ROOM -->
<div id="room" class="room hidden">
  <div class="header">
    <span>ğŸ¤– Trá»ng tÃ i Â· <span id="rootWord"></span></span>
    <div>
      <button id="copyLink">ğŸ”—</button>
      <button id="resetGame" class="hidden">ğŸ”</button>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-row">
    <input id="text" placeholder="Nháº­p tá»« ghÃ©p">
    <button class="send" onclick="send()">Gá»­i</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getDatabase, ref, push, onChildAdded, set, get, update
} from
  "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ===== CONFIG ===== */
const HOST_CODE = "1.2991.22283.33";

const params = new URLSearchParams(location.search);
const roomId = params.get("room") || "phong-chung";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  authDomain: "noitu-7dca6.firebaseapp.com",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6",
  messagingSenderId: "253854569418",
  appId: "1:253854569418:web:105e8e3edfdd9baafff533"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const chatRef = ref(db, `rooms/${roomId}/chat`);
const stateRef = ref(db, `rooms/${roomId}/state`);
const playersRef = ref(db, `rooms/${roomId}/players`);

let name="", isHost=false, eliminated=false;

/* UI */
const chat=document.getElementById("chat");
const rootEl=document.getElementById("rootWord");
const toast=document.getElementById("toast");

function notify(msg, ok=true){
  toast.className="";
  toast.textContent=msg;
  toast.classList.add("show",ok?"toast-ok":"toast-bad");
  setTimeout(()=>toast.classList.remove("show"),1200);
}
function add(text, cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ENTER */
window.enter = async ()=>{
  name=nameInput.value.trim();
  if(!name) return;

  isHost = hostInput.value.trim()===HOST_CODE;
  if(isHost) document.getElementById("resetGame").classList.remove("hidden");

  await set(ref(db,`rooms/${roomId}/players/${name}`),{
    alive:true, score:0
  });

  login.classList.add("hidden");
  room.classList.remove("hidden");

  const s=await get(stateRef);
  if(!s.exists()){
    const roots=["tá»•","con","ma","quá»‘c","há»“n"];
    const root=roots[Math.floor(Math.random()*roots.length)];
    await set(stateRef,{root,status:"playing"});
    add("ğŸ¤– Báº¯t Ä‘áº§u vá»›i: "+root,"system");
    rootEl.textContent="Gá»‘c: "+root;
  }else{
    rootEl.textContent="Gá»‘c: "+s.val().root;
  }
};

/* LISTEN CHAT */
onChildAdded(chatRef,s=>{
  const d=s.val();
  add(d.text,d.cls);
});

/* COPY LINK */
copyLink.onclick=()=>{
  navigator.clipboard.writeText(
    location.origin+location.pathname+"?room="+roomId
  );
  notify("ÄÃ£ copy link");
};

/* RESET GAME â€“ HOST ONLY */
resetGame.onclick=async()=>{
  if(!isHost) return;
  await set(ref(db,`rooms/${roomId}`),null);
  location.reload();
};

/* CHECK WINNER */
async function checkWinner(){
  const snap=await get(playersRef);
  if(!snap.exists()) return;
  const ps=snap.val();
  const alive=Object.keys(ps).filter(p=>ps[p].alive);
  if(alive.length===1){
    const w=alive[0];
    push(chatRef,{text:`ğŸ† ${w} chiáº¿n tháº¯ng!`,cls:"system"});
    showBXH();
    await update(stateRef,{status:"ended",winner:w});
  }
}

/* BXH */
async function showBXH(){
  const snap=await get(playersRef);
  if(!snap.exists()) return;
  const arr=Object.entries(snap.val())
    .map(([n,v])=>({n,score:v.score||0}))
    .sort((a,b)=>b.score-a.score);

  push(chatRef,{
    text:"ğŸ“Š BXH: "+arr.map(
      (p,i)=>`${i+1}.${p.n}(${p.score})`
    ).join(" | "),
    cls:"bxh"
  });
}

/* SEND */
window.send = async ()=>{
  if(eliminated) return notify("Báº¡n Ä‘Ã£ bá»‹ loáº¡i",false);

  const val=text.value.trim().toLowerCase();
  if(!val) return;
  text.value="";

  const st=(await get(stateRef)).val();
  if(st.status==="ended") return notify("Game Ä‘Ã£ káº¿t thÃºc",false);

  const parts=val.split(/\s+/);
  if(parts.length<2||parts[0]!==st.root){
    eliminated=true;
    await update(ref(db,`rooms/${roomId}/players/${name}`),{alive:false});
    push(chatRef,{text:`âŒ ${name} sai vÃ  bá»‹ loáº¡i`,cls:"wrong"});
    await checkWinner();
    return;
  }

  await update(ref(db,`rooms/${roomId}/players/${name}`),{
    score: (await get(ref(db,`rooms/${roomId}/players/${name}/score`))).val()+1
  });

  const next=parts[parts.length-1];
  await update(stateRef,{root:next});
  push(chatRef,{text:`âœ… ${name}: ${val}`,cls:"correct"});
  rootEl.textContent="Gá»‘c: "+next;
  await checkWinner();
};
</script>

</body>
</html>
