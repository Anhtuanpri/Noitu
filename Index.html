<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>N·ªëi T·ª´ Gh√©p AI</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#1e0b4b,#020617);
  color:#e5e7eb;
}
.neon{
  color:#c4b5fd;
  text-shadow:0 0 12px rgba(168,85,247,.9);
}
.center{
  display:flex;align-items:center;justify-content:center;
  height:100vh;
}
.glass{
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(16px);
  border-radius:20px;
  box-shadow:0 0 40px rgba(168,85,247,.5);
}
.login{
  width:380px;padding:28px;
  text-align:center;
}
.login input{
  width:100%;margin:8px 0;
  padding:14px;border:none;border-radius:14px;
}
.login button{
  width:100%;padding:14px;
  margin-top:10px;
  border:none;border-radius:14px;
  background:linear-gradient(135deg,#7c3aed,#22d3ee);
  color:#020617;font-weight:800;
  cursor:pointer;
}
.room{
  max-width:640px;
  margin:0 auto;height:100vh;
  display:flex;flex-direction:column;
}
.header{
  padding:12px 16px;
  display:flex;justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #334155;
}
.header button{
  margin-left:6px;
  padding:6px 10px;
  border:none;border-radius:10px;
  font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,#22d3ee,#a855f7);
}
.chat{flex:1;overflow:auto;padding:14px}
.msg{
  margin:6px 0;padding:10px 14px;
  border-radius:14px;max-width:90%;
}
.system{background:#1e293b;color:#93c5fd}
.correct{
  background:#052e16;color:#4ade80;
  box-shadow:0 0 12px rgba(34,197,94,.7);
}
.wrong{
  background:#450a0a;color:#fca5a5;
  box-shadow:0 0 12px rgba(239,68,68,.8);
}
.bxh{
  background:#020617;color:#fde68a;
  border:1px dashed #facc15;
}
.input{
  display:flex;gap:8px;
  padding:12px;border-top:1px solid #334155;
}
.input input{
  flex:1;padding:14px;
  border:none;border-radius:14px;
}
.input button{
  padding:14px 18px;
  border:none;border-radius:14px;
  background:#7c3aed;color:white;
  font-weight:800;
}
.hidden{display:none}

/* toast */
#toast{
  position:fixed;top:20px;right:20px;
  padding:12px 16px;border-radius:14px;
  font-weight:700;opacity:0;transition:.25s;
}
#toast.show{opacity:1}
.toast-ok{background:#052e16;color:#4ade80}
.toast-bad{background:#450a0a;color:#f87171}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="glass login">
    <h2 class="neon">üîÆ N·ªêI T·ª™ GH√âP</h2>
    <input id="nameInput" placeholder="T√™n c·ªßa b·∫°n">
    <input id="hostInput" placeholder="M√£ host (n·∫øu c√≥)">
    <button onclick="enter()">V√ÄO PH√íNG</button>
    <p style="font-size:13px;color:#9ca3af">
      T√™n s·∫Ω ƒë∆∞·ª£c l∆∞u ‚Äì ch·ªâ ƒë·ªïi khi x√≥a l·ªãch s·ª≠
    </p>
  </div>
</div>

<!-- ROOM -->
<div id="room" class="room hidden">
  <div class="header">
    <div>
      ü§ñ <span id="rootWord" class="neon"></span>
    </div>
    <div>
      <button id="modeList" class="hidden">‚ö° LIST</button>
      <button id="modeGPT" class="hidden">ü§ñ GPT</button>
      <button id="resetGame" class="hidden">üîÅ</button>
      <button id="copyLink">üîó</button>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input">
    <input id="text" placeholder="Nh·∫≠p t·ª´ gh√©p">
    <button onclick="send()">G·ª¨I</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
/* ================= CONFIG ================= */
const HOST_CODE = "1.2991.22283.33";
const OPENAI_API_KEY = "sk-XXXXXXXXXXXXXXXXXXXX"; // <-- d√°n key

/* demo list t·ª´ gh√©p */
const WORD_LIST = [
  "t·ªï qu·ªëc","qu·ªëc gia","gia ƒë√¨nh","ƒë√¨nh l√†ng",
  "l√†ng qu√™","qu√™ h∆∞∆°ng","h∆∞∆°ng s·∫Øc","s·∫Øc ƒë·∫πp",
  "ƒë·∫πp ng∆∞·ªùi","ng∆∞·ªùi d√¢n","d√¢n t·ªôc","t·ªôc ng∆∞·ªùi"
];

/* ============ FIREBASE ============ */
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getDatabase, ref, push, get, set, update, onChildAdded
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const params=new URLSearchParams(location.search);
const roomId=params.get("room")||"phong-chung";

const firebaseConfig={
  apiKey:"AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  authDomain:"noitu-7dca6.firebaseapp.com",
  databaseURL:"https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"noitu-7dca6",
  messagingSenderId:"253854569418",
  appId:"1:253854569418:web:105e8e3edfdd9baafff533"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const chatRef=ref(db,`rooms/${roomId}/chat`);
const stateRef=ref(db,`rooms/${roomId}/state`);
const playersRef=ref(db,`rooms/${roomId}/players`);

/* ============ STATE ============ */
let name="", isHost=false, eliminated=false;

/* ============ UI HELPERS ============ */
const toast=document.getElementById("toast");
function notify(msg,ok=true){
  toast.textContent=msg;
  toast.className="show "+(ok?"toast-ok":"toast-bad");
  setTimeout(()=>toast.className="",1200);
}
function add(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ============ LOGIN ============ */
const savedName=localStorage.getItem("noitu_name");
if(savedName) nameInput.value=savedName;

window.enter=async()=>{
  name=nameInput.value.trim();
  if(!name) return;
  localStorage.setItem("noitu_name",name);

  isHost = hostInput.value.trim()===HOST_CODE;
  if(isHost){
    resetGame.classList.remove("hidden");
    modeList.classList.remove("hidden");
    modeGPT.classList.remove("hidden");
  }

  await set(ref(db,`rooms/${roomId}/players/${name}`),{
    alive:true,score:0
  });

  login.classList.add("hidden");
  room.classList.remove("hidden");

  const snap=await get(stateRef);
  if(!snap.exists()){
    const root=WORD_LIST[0].split(" ")[0];
    await set(stateRef,{root,mode:"list",status:"playing"});
    rootWord.textContent="G·ªëc: "+root;
    add("ü§ñ B·∫Øt ƒë·∫ßu v·ªõi: "+root,"system");
  }else{
    rootWord.textContent="G·ªëc: "+snap.val().root;
  }
};

/* ============ MODE SELECT ============ */
modeList.onclick=()=>update(stateRef,{mode:"list"});
modeGPT.onclick=()=>update(stateRef,{mode:"gpt"});

/* ============ CHAT LISTEN ============ */
onChildAdded(chatRef,s=>add(s.val().text,s.val().cls));

/* ============ CHECKERS ============ */
function checkByList(root,word){
  const ok=WORD_LIST.find(w=>w===word && w.startsWith(root+" "));
  return ok?word.split(" ").pop():null;
}

async function checkByGPT(root,word){
  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"B·∫°n l√† tr·ªçng t√†i n·ªëi t·ª´ gh√©p ti·∫øng Vi·ªát."},
        {role:"user",content:
`T·ª´ g·ªëc: "${root}"
Ng∆∞·ªùi ch∆°i: "${word}"
Tr·∫£ JSON {"valid":true,"next":"t·ª´"} ho·∫∑c {"valid":false}`}
      ],
      temperature:0,max_tokens:60
    })
  });
  const j=await r.json();
  return JSON.parse(j.choices[0].message.content);
}

/* ============ GAME LOGIC ============ */
async function checkWinner(){
  const snap=await get(playersRef);
  const ps=snap.val();
  const alive=Object.keys(ps).filter(p=>ps[p].alive);
  if(alive.length===1){
    const w=alive[0];
    push(chatRef,{text:`üèÜ ${w} CHI·∫æN TH·∫ÆNG!`,cls:"system"});
    showBXH();
    await update(stateRef,{status:"ended"});
  }
}

async function showBXH(){
  const snap=await get(playersRef);
  const arr=Object.entries(snap.val())
    .map(([n,v])=>({n,score:v.score||0}))
    .sort((a,b)=>b.score-a.score);
  push(chatRef,{
    text:"üìä BXH: "+arr.map(
      (p,i)=>`${i+1}.${p.n}(${p.score})`
    ).join(" | "),
    cls:"bxh"
  });
}

/* ============ SEND ============ */
window.send=async()=>{
  if(eliminated) return notify("B·∫°n ƒë√£ b·ªã lo·∫°i",false);
  const val=text.value.trim().toLowerCase();
  if(!val) return;
  text.value="";

  const st=(await get(stateRef)).val();
  if(st.status==="ended") return;

  try{
    let next;
    if(st.mode==="list"){
      next=checkByList(st.root,val);
      if(!next) throw "sai";
    }else{
      const rs=await checkByGPT(st.root,val);
      if(!rs.valid) throw "sai";
      next=rs.next;
    }

    const sSnap=await get(ref(db,`rooms/${roomId}/players/${name}/score`));
    await update(ref(db,`rooms/${roomId}/players/${name}`),{
      score:(sSnap.val()||0)+1
    });
    await update(stateRef,{root:next});
    push(chatRef,{text:`‚úÖ ${name}: ${val}`,cls:"correct"});
    rootWord.textContent="G·ªëc: "+next;
    await checkWinner();

  }catch{
    eliminated=true;
    await update(ref(db,`rooms/${roomId}/players/${name}`),{alive:false});
    push(chatRef,{text:`‚ùå ${name} b·ªã lo·∫°i`,cls:"wrong"});
    await checkWinner();
  }
};

/* RESET */
resetGame.onclick=async()=>{
  if(!isHost) return;
  await set(ref(db,`rooms/${roomId}`),null);
  location.reload();
};

/* COPY LINK */
copyLink.onclick=()=>{
  navigator.clipboard.writeText(
    location.origin+location.pathname+"?room="+roomId
  );
  notify("ƒê√£ copy link");
};
</script>

</body>
</html>
