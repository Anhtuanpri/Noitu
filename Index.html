<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ph√≤ng N·ªëi Ch·ªØ</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase SDK v12 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded }
    from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiv0nqf1Gse7sDxwVVon-LtL_kbkLYS3A",
    authDomain: "noitu-560ef.firebaseapp.com",
    projectId: "noitu-560ef",
    databaseURL: "https://noitu-560ef-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const roomId = new URLSearchParams(location.search).get("room");
  const user = localStorage.getItem("username");
  const roomRef = ref(db, "rooms/" + roomId + "/chat");

  const chatBox = document.getElementById("chatBox");

  function addMsg(user, text, host=false){
    const div = document.createElement("div");
    div.className = "msg " + (host ? "host" : "user");
    div.innerHTML = `<b>${user}</b><br>${text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  onChildAdded(roomRef, snap=>{
    const d = snap.val();
    addMsg(d.user, d.text, d.user==="HOST");
  });

  window.send = async function(){
    const input = document.getElementById("input");
    const text = input.value.trim();
    if(!text) return;
    input.value = "";

    // g·ª≠i chat cho m·ªçi ng∆∞·ªùi
    push(roomRef,{ user, text });

    // command
    if(text.startsWith("/")){
      const isStart = text.startsWith("/start");
      const endpoint = isStart ? "/start" : "/host";
      const body = isStart ? { word:text.replace("/start","").trim() } : {};

      const r = await fetch(endpoint,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const d = await r.json();

      push(roomRef,{ user:"HOST", text:d.text || d.host });
    }
  }
</script>
</head>

<body>

<div class="layout">
  <div class="header">
    üë• Ph√≤ng: <span id="roomName"></span>
  </div>

  <div id="chatBox" class="chat"></div>

  <div class="input-row">
    <input id="input" placeholder="/host | /start v√¨ | nh·∫≠p t·ª´">
    <button onclick="send()">G·ª≠i</button>
  </div>
</div>

<script>
document.getElementById("roomName").innerText =
  new URLSearchParams(location.search).get("room");
</script>

</body>
</html>
