<!DOCTYPE html>
<html lang="en">
<head>
<base href="https://cdn.jsdelivr.net/gh/VinMannie/Run_3@gh-pages/">
<meta charset="utf-8">
<title>Run 3 Mobile – FULL FIX</title>

<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="shortcut icon" href="./favicon.png">
<script src="https://cdn.jsdelivr.net/gh/cooldude2349/bugfixes@main/Run3beta.js"></script>

<style>
html,body{
    margin:0;
    padding:0;
    height:100%;
    overflow:hidden;
    background:#000;
    touch-action:none;
}
#openfl-content{
    width:100%;
    height:100%;
}

/* ===== BUTTONS ===== */
.control{
    position:fixed;
    bottom:22px;
    width:80px;
    height:80px;
    border-radius:50%;
    background:rgba(255,255,255,0.25);
    border:2px solid rgba(255,255,255,0.6);
    color:#fff;
    font-size:34px;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    pointer-events:auto;
    z-index:9999; /* QUAN TRỌNG */
}
#leftBtn{ left:20px; }
#rightBtn{ right:20px; }
</style>
</head>

<body>
<div id="openfl-content"></div>

<div id="leftBtn" class="control">⟲</div>
<div id="rightBtn" class="control">⟳</div>

<script>
lime.embed("Run3","openfl-content",800,600,{});

/* ===== KEY SENDER ===== */
function key(type, code, kc){
    document.dispatchEvent(new KeyboardEvent(type,{
        code:code,
        key:code==="Space"?" ":code,
        keyCode:kc,
        which:kc,
        bubbles:true
    }));
}

/* =====================
   JUMP (CHỈ KHI KHÔNG ẤN NÚT)
   ===================== */
let jumping = false;

document.addEventListener("touchstart", e=>{
    if(e.target.classList.contains("control")) return;
    e.preventDefault();
    jumping = true;
    key("keydown","Space",32);
},{passive:false});

document.addEventListener("touchend", e=>{
    if(jumping){
        key("keyup","Space",32);
        jumping = false;
    }
},{passive:false});

/* =====================
   HOLD ROTATE (NÚT)
   ===================== */
let rotateTimer = null;
const ROTATE_SPEED = 30; // càng nhỏ xoay càng nhanh

function startRotate(dir){
    if(rotateTimer) return;
    rotateTimer = setInterval(()=>{
        if(dir==="left"){
            key("keydown","ArrowLeft",37);
            key("keyup","ArrowLeft",37);
        }else{
            key("keydown","ArrowRight",39);
            key("keyup","ArrowRight",39);
        }
    }, ROTATE_SPEED);
}

function stopRotate(){
    clearInterval(rotateTimer);
    rotateTimer = null;
}

function bindRotate(btn, dir){
    btn.addEventListener("touchstart", e=>{
        e.preventDefault();
        e.stopPropagation(); // QUAN TRỌNG
        startRotate(dir);
    }, {passive:false});

    btn.addEventListener("touchend", e=>{
        e.preventDefault();
        e.stopPropagation();
        stopRotate();
    }, {passive:false});

    btn.addEventListener("touchcancel", stopRotate);
}

bindRotate(leftBtn, "left");
bindRotate(rightBtn, "right");

/* block scroll hoàn toàn */
document.body.addEventListener("touchmove", e=>{
    e.preventDefault();
}, {passive:false});
</script>

</body>
</html>
