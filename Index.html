<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ná»‘i Tá»« GhÃ©p AI</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui;
  background:linear-gradient(135deg,#020617,#120029);
  color:#e5e7eb;
}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.card{
  width:380px;padding:24px;border-radius:18px;
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(14px);
  box-shadow:0 0 30px rgba(139,92,246,.4);
  text-align:center;
}
.room{max-width:650px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.header{
  padding:12px;border-bottom:1px solid #334155;
  display:flex;justify-content:space-between;align-items:center;
  color:#c4b5fd;
}
.header button{
  background:linear-gradient(135deg,#22d3ee,#a855f7);
  border:none;border-radius:12px;
  padding:6px 12px;font-weight:700;cursor:pointer;
}
.chat{flex:1;overflow:auto;padding:12px}
.msg{margin:6px 0;padding:10px 14px;border-radius:14px;max-width:90%;white-space:pre-line}
.system{background:#1e293b;color:#93c5fd}
.correct{background:#052e16;color:#4ade80}
.wrong{background:#450a0a;color:#f87171}
.admin{background:#312e81;color:#c7d2fe}
.input-row{
  display:flex;gap:8px;padding:10px;
  border-top:1px solid #334155;
}
input{flex:1;padding:12px;border:none;border-radius:10px}
button.send{
  padding:12px 18px;border:none;border-radius:10px;
  background:#7c3aed;color:#fff;font-weight:700;
}
.hidden{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card">
    <h2>ğŸ”® Ná»I Tá»ª GHÃ‰P AI</h2>
    <input id="nameInput" placeholder="TÃªn cá»§a báº¡n">
    <input id="hostInput" placeholder="MÃ£ admin (172727.7777)">
    <button id="enterBtn">VÃ o chÆ¡i</button>
    <p style="font-size:13px;color:#aaa">
      /bot /botgpt Â· /reset (admin)
    </p>
  </div>
</div>

<!-- ROOM -->
<div id="room" class="room hidden">
  <div class="header">
    <span>ğŸ¤– AI Trá»ng TÃ i Â· <span id="rootWord"></span></span>
    <button id="resetBtn" class="hidden">RESET</button>
  </div>
  <div id="chat" class="chat"></div>
  <div class="input-row">
    <input id="text" placeholder="Nháº­p tá»« ghÃ©p hoáº·c lá»‡nh">
    <button class="send">Gá»­i</button>
  </div>
</div>

<script type="module">
/* ===== CONFIG ===== */
const OPENAI_API_KEY = "sk-XXXXXXXXXXXXXXXXXXXXXXXX";
const HOST_CODE = "172727.7777";
const MAX_ADMINS = 3;

/* ===== FIREBASE ===== */
import { initializeApp } from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getDatabase, ref, push, onChildAdded,
  set, get, update
} from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6"
});
const db = getDatabase(app);

const params = new URLSearchParams(location.search);
const roomId = params.get("room") || "phong-chung";

const stateRef   = ref(db,`rooms/${roomId}/state`);
const chatRef    = ref(db,`rooms/${roomId}/chat`);
const playersRef = ref(db,`rooms/${roomId}/players`);
const adminsRef  = ref(db,`rooms/${roomId}/admins`);

/* ===== STATE ===== */
let name = localStorage.getItem("noitu_name") || "";
let isAdmin=false, eliminated=false, gameOver=false;
let WORDS=[];

/* ===== UI ===== */
const login=document.getElementById("login");
const room=document.getElementById("room");
const nameInput=document.getElementById("nameInput");
const hostInput=document.getElementById("hostInput");
const rootEl=document.getElementById("rootWord");
const chat=document.getElementById("chat");
const resetBtn=document.getElementById("resetBtn");
nameInput.value=name;

function add(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ===== WORD LIST ===== */
async function loadWords(){
  const r=await fetch("words.txt");
  WORDS=(await r.text()).split("\n").map(w=>w.trim()).filter(Boolean);
}

/* ===== AI ROOT ===== */
async function aiRoot(){
  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"Táº¡o 1 tá»« gá»‘c Ä‘á»ƒ chÆ¡i ná»‘i tá»« ghÃ©p tiáº¿ng Viá»‡t"},
        {role:"user",content:"Tráº£ JSON {\"root\":\"tá»«\"}"}
      ],
      max_tokens:40
    })
  });
  return JSON.parse((await r.json()).choices[0].message.content).root;
}

/* ===== ENTER ===== */
document.getElementById("enterBtn").onclick = async ()=>{
  name=nameInput.value.trim();
  if(!name) return;

  localStorage.setItem("noitu_name",name);
  await loadWords();

  login.classList.add("hidden");
  room.classList.remove("hidden");

  /* player */
  const pRef=ref(db,`rooms/${roomId}/players/${name}`);
  if(!(await get(pRef)).exists()){
    await set(pRef,{alive:true,score:0});
  }

  /* admin */
  const admins=(await get(adminsRef)).val()||{};
  if(hostInput.value.trim()===HOST_CODE && Object.keys(admins).length<MAX_ADMINS){
    await update(adminsRef,{[name]:true});
    isAdmin=true;
  }else if(admins[name]){
    isAdmin=true;
  }
  if(isAdmin) resetBtn.classList.remove("hidden");

  /* state */
  const sSnap=await get(stateRef);
  if(!sSnap.exists()){
    const root=await aiRoot();
    await set(stateRef,{root});
    rootEl.textContent="Gá»‘c: "+root;
    add("ğŸ¤– AI ra Ä‘á»: "+root,"system");
  }else{
    rootEl.textContent="Gá»‘c: "+sSnap.val().root;
  }
};

/* ===== CHAT LISTEN ===== */
onChildAdded(chatRef,s=>add(s.val().text,s.val().cls));

/* ===== GPT CHECK ===== */
async function gptCheck(root,val){
  if(!WORDS.includes(val) || !val.startsWith(root+" ")) return {valid:false};

  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"Cháº¥m ná»‘i tá»« ghÃ©p tiáº¿ng Viá»‡t"},
        {role:"user",content:`Gá»‘c ${root}, tá»« ${val}. Tráº£ JSON {"valid":true,"next":"tá»«"} hoáº·c {"valid":false}`}
      ],
      max_tokens:50
    })
  });
  return JSON.parse((await r.json()).choices[0].message.content);
}

/* ===== RESET ===== */
async function handleReset(){
  if(!isAdmin) return;
  eliminated=false; gameOver=false;
  await set(stateRef,null);
  const ps=(await get(playersRef)).val()||{};
  for(const p in ps){
    await update(ref(db,`rooms/${roomId}/players/${p}`),{
      alive:true,score:0
    });
  }
  add("ğŸ” Admin reset game","system");
}

/* ===== SEND ===== */
document.querySelector(".send").onclick = async ()=>{
  let val=text.value.trim().toLowerCase();
  if(!val) return;
  text.value="";

  if(!isAdmin && (eliminated||gameOver)) return;

  if(val==="/reset"){ await handleReset(); return; }
  if(val==="/bot"||val==="/botgpt"){
    add(`ğŸ¤– ${name} báº­t GPT cháº¥m`,"system");
    return;
  }

  const st=(await get(stateRef)).val();
  try{
    const rs=await gptCheck(st.root,val);
    if(!rs.valid) throw 0;

    await update(stateRef,{root:rs.next});
    if(!isAdmin){
      const sRef=ref(db,`rooms/${roomId}/players/${name}/score`);
      await set(sRef,((await get(sRef)).val()||0)+1);
    }
    push(chatRef,{text:`âœ… ${name}: ${val}`,cls:"correct"});

  }catch{
    if(isAdmin){
      push(chatRef,{text:`âš ï¸ ${name} (admin) sai`,cls:"admin"});
    }else{
      eliminated=true;
      await update(ref(db,`rooms/${roomId}/players/${name}`),{alive:false});
      push(chatRef,{text:`âŒ ${name} bá»‹ loáº¡i`,cls:"wrong"});
    }
  }

  const ps=(await get(playersRef)).val()||{};
  const alive=Object.entries(ps).filter(([_,v])=>v.alive);
  if(alive.length===1 && !gameOver){
    gameOver=true;
    const rank=Object.entries(ps)
      .sort((a,b)=>(b[1].score||0)-(a[1].score||0))
      .map(([n,v],i)=>`${i+1}. ${n} (${v.score||0})`).join("\n");
    push(chatRef,{text:`ğŸ† ${alive[0][0]} tháº¯ng!\nğŸ“Š BXH:\n${rank}`,cls:"system"});
  }
};

resetBtn.onclick = handleReset;
</script>
</body>
</html>
