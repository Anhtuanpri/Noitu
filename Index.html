<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>N·ªëi T·ª´ Gh√©p AI</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#020617,#120029);
  color:#e5e7eb;
}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.card{
  width:360px;padding:24px;border-radius:18px;
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(14px);
  box-shadow:0 0 30px rgba(139,92,246,.4);
  text-align:center;
}
.room{
  max-width:600px;margin:0 auto;height:100vh;
  display:flex;flex-direction:column;
}
.header{
  padding:12px;border-bottom:1px solid #334155;
  display:flex;justify-content:space-between;align-items:center;
  color:#c4b5fd;
}
.header button{
  background:linear-gradient(135deg,#22d3ee,#a855f7);
  border:none;border-radius:12px;
  padding:6px 10px;font-weight:700;
  cursor:pointer;
}
.chat{flex:1;overflow:auto;padding:12px}
.msg{margin:6px 0;padding:10px 14px;border-radius:14px;max-width:90%}
.system{background:#1e293b;color:#93c5fd;white-space:pre-line}
.correct{background:#052e16;color:#4ade80}
.wrong{background:#450a0a;color:#f87171}
.input-row{
  display:flex;gap:8px;padding:10px;
  border-top:1px solid #334155;
}
input{flex:1;padding:12px;border:none;border-radius:10px}
button.send{
  padding:12px 16px;border:none;border-radius:10px;
  background:#7c3aed;color:#fff;font-weight:700;
}
.hidden{display:none}
#toast{
  position:fixed;top:20px;right:20px;
  padding:10px 14px;border-radius:12px;
  font-weight:700;opacity:0;transition:.25s;
}
#toast.show{opacity:1}
.toast-ok{background:#052e16;color:#4ade80}
.toast-bad{background:#450a0a;color:#f87171}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card">
    <h2>üîÆ N·ªêI T·ª™ GH√âP AI</h2>
    <input id="nameInput" placeholder="T√™n c·ªßa b·∫°n">
    <button onclick="enter()">V√†o ch∆°i</button>
    <p style="font-size:13px;color:#aaa">
      /start list ¬∑ /bot GPT ¬∑ /reset (admin)
    </p>
  </div>
</div>

<!-- ROOM -->
<div id="room" class="room hidden">
  <div class="header">
    <span>ü§ñ Tr·ªçng t√†i ¬∑ <span id="rootWord"></span></span>
    <button id="copyLink">üîó</button>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-row">
    <input id="text" placeholder="Nh·∫≠p t·ª´ gh√©p ho·∫∑c l·ªánh">
    <button class="send" onclick="send()">G·ª≠i</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
/* ================= GPT API ================= */
const OPENAI_API_KEY = "sk-XXXXXXXXXXXXXXXXXXXXXXXX";

/* ================= FIREBASE ================= */
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getDatabase, ref, push, onChildAdded,
  set, get, update
} from
  "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const params = new URLSearchParams(location.search);
const roomId = params.get("room") || "phong-chung";

const app = initializeApp({
  apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk",
  authDomain: "noitu-7dca6.firebaseapp.com",
  databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "noitu-7dca6",
  appId: "1:253854569418:web:105e8e3edfdd9baafff533"
});
const db = getDatabase(app);

const stateRef   = ref(db,`rooms/${roomId}/state`);
const chatRef    = ref(db,`rooms/${roomId}/chat`);
const playersRef = ref(db,`rooms/${roomId}/players`);
const adminRef   = ref(db,`rooms/${roomId}/admin`);

/* ================= STATE LOCAL ================= */
let name = "";
let eliminated = false;
let mode = "list";
let WORDS = [];
let gameOver = false;

/* ================= UI ================= */
const chat = document.getElementById("chat");
const toast = document.getElementById("toast");
const rootEl = document.getElementById("rootWord");

function notify(msg,ok=true){
  toast.textContent=msg;
  toast.className="show "+(ok?"toast-ok":"toast-bad");
  setTimeout(()=>toast.className="",1000);
}
function add(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ================= WORD LIST ================= */
async function loadWords(){
  const r=await fetch("words.txt");
  WORDS=(await r.text()).split("\n").map(w=>w.trim()).filter(Boolean);
}

/* ================= AI RA ƒê·ªÄ (T·ª™ G·ªêC) ================= */
async function aiGenerateRoot(){
  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"B·∫°n t·∫°o ƒë·ªÅ n·ªëi t·ª´ gh√©p ti·∫øng Vi·ªát."},
        {role:"user",content:"Cho 1 t·ª´ g·ªëc (1 t·ª´ ƒë∆°n, ph·ªï bi·∫øn, ph√π h·ª£p n·ªëi t·ª´ gh√©p). Tr·∫£ JSON {\"root\":\"t·ª´\"}."}
      ],
      temperature:0.7,
      max_tokens:40
    })
  });
  const j=await r.json();
  return JSON.parse(j.choices[0].message.content).root;
}

/* ================= ENTER ================= */
window.enter = async ()=>{
  name = nameInput.value.trim();
  if(!name) return;

  localStorage.setItem("noitu_name",name);
  await loadWords();

  login.classList.add("hidden");
  room.classList.remove("hidden");

  /* register player */
  const pRef = ref(db,`rooms/${roomId}/players/${name}`);
  const pSnap = await get(pRef);
  if(!pSnap.exists()){
    await set(pRef,{ alive:true, score:0 });
  }

  /* admin */
  const aSnap = await get(adminRef);
  if(!aSnap.exists()){
    await set(adminRef,name);
    add(`üëë ${name} l√† qu·∫£n tr·ªã`, "system");
  }

  /* state */
  const sSnap = await get(stateRef);
  if(!sSnap.exists()){
    const root = await aiGenerateRoot(); // ‚≠ê AI RA ƒê·ªÄ
    await set(stateRef,{ root });
    add("ü§ñ AI ra ƒë·ªÅ: "+root,"system");
    rootEl.textContent="G·ªëc: "+root;
  }else{
    rootEl.textContent="G·ªëc: "+sSnap.val().root;
  }
};

/* ================= CHAT LISTEN ================= */
onChildAdded(chatRef,s=>add(s.val().text,s.val().cls));

/* ================= CHECKERS ================= */
function checkByList(root,word){
  return WORDS.includes(word) && word.startsWith(root+" ")
    ? word.split(" ").pop() : null;
}

async function checkByGPT(root,word){
  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+OPENAI_API_KEY
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"B·∫°n l√† tr·ªçng t√†i n·ªëi t·ª´ gh√©p ti·∫øng Vi·ªát."},
        {role:"user",content:
          `T·ª´ g·ªëc "${root}", t·ª´ "${word}". Tr·∫£ JSON {"valid":true,"next":"t·ª´"} ho·∫∑c {"valid":false}` }
      ],
      temperature:0,
      max_tokens:60
    })
  });
  return JSON.parse((await r.json()).choices[0].message.content);
}

/* ================= CHECK END GAME ================= */
async function checkGameEnd(){
  if(gameOver) return;

  const snap = await get(playersRef);
  if(!snap.exists()) return;

  const players = snap.val();
  const alive = Object.entries(players).filter(([_,v])=>v.alive);

  if(alive.length !== 1) return;

  gameOver = true;
  const winner = alive[0][0];

  const ranking = Object.entries(players)
    .sort((a,b)=>(b[1].score||0)-(a[1].score||0))
    .map(([n,v],i)=>`${i+1}. ${n} (${v.score||0})`)
    .join("\n");

  push(chatRef,{
    text:`üèÜ CHI·∫æN TH·∫ÆNG: ${winner}\n\nüìä B·∫¢NG X·∫æP H·∫†NG:\n${ranking}`,
    cls:"system"
  });

  notify(`${winner} th·∫Øng cu·ªôc!`,true);
}

/* ================= SEND ================= */
window.send = async ()=>{
  if(eliminated || gameOver){
    notify("Kh√¥ng th·ªÉ g·ª≠i",false);
    return;
  }

  const val=text.value.trim().toLowerCase();
  if(!val) return;
  text.value="";

  /* COMMANDS */
  if(val==="/start"){ mode="list"; notify("D√πng LIST"); return; }
  if(val==="/bot"){ mode="bot"; notify("D√πng GPT"); return; }

  if(val==="/reset"){
    const admin=(await get(adminRef)).val();
    if(name!==admin){ notify("Kh√¥ng ph·∫£i admin",false); return; }
    gameOver=false;
    await set(stateRef,null);
    await set(playersRef,null);
    add("üîÅ Game ƒë√£ reset","system");
    return;
  }

  const st=(await get(stateRef)).val();

  try{
    let next;
    if(mode==="list"){
      next=checkByList(st.root,val);
      if(!next) throw 0;
    }else{
      const rs=await checkByGPT(st.root,val);
      if(!rs.valid) throw 0;
      next=rs.next;
    }

    await update(stateRef,{root:next});
    const scoreRef=ref(db,`rooms/${roomId}/players/${name}/score`);
    const cur=(await get(scoreRef)).val()||0;
    await set(scoreRef,cur+1);

    push(chatRef,{text:`‚úÖ ${name}: ${val}`,cls:"correct"});
    rootEl.textContent="G·ªëc: "+next;

  }catch{
    eliminated=true;
    await update(ref(db,`rooms/${roomId}/players/${name}`),{alive:false});
    push(chatRef,{text:`‚ùå ${name} b·ªã lo·∫°i`,cls:"wrong"});
  }

  await checkGameEnd(); // ‚≠ê FIX QUY·∫æT ƒê·ªäNH
};
</script>

</body>
</html>
