<!DOCTYPE html>
<html lang="en">
<head>
    <base href="https://cdn.jsdelivr.net/gh/VinMannie/Run_3@gh-pages/">
    <meta charset="utf-8">

    <title>Run 3 – Mobile Fixed</title>

    <meta name="viewport"
          content="width=device-width,height=device-height,initial-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="shortcut icon" href="./favicon.png">

    <!-- Run 3 engine -->
    <script src="https://cdn.jsdelivr.net/gh/cooldude2349/bugfixes@main/Run3beta.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        #openfl-content {
            width: 100%;
            height: 100%;
            background: #000;
        }
    </style>
</head>

<body>

<noscript>Please enable JavaScript</noscript>
<div id="openfl-content"></div>

<script>
/* ========= EMBED GAME ========= */
lime.embed("Run3", "openfl-content", 800, 600, {});

/* ========= KEY EMULATOR ========= */
function sendKey(type, code, key, keyCode) {
    document.dispatchEvent(
        new KeyboardEvent(type, {
            code: code,
            key: key,
            keyCode: keyCode,
            which: keyCode,
            bubbles: true
        })
    );
}

/* ========= HOLD JUMP (FIX CHÍNH) ========= */
let jumpLoop = null;

document.addEventListener("touchstart", e => {
    e.preventDefault();

    if (!jumpLoop) {
        // gửi liên tục để engine hiểu là ĐANG GIỮ
        sendKey("keydown", "Space", " ", 32);
        jumpLoop = setInterval(() => {
            sendKey("keydown", "Space", " ", 32);
        }, 30); // ~33fps
    }
}, { passive: false });

document.addEventListener("touchend", e => {
    e.preventDefault();

    if (jumpLoop) {
        clearInterval(jumpLoop);
        jumpLoop = null;
    }
    sendKey("keyup", "Space", " ", 32);
}, { passive: false });

/* ========= SWIPE ROTATE ========= */
let startX = null;

document.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
}, { passive: false });

document.addEventListener("touchend", e => {
    if (startX === null) return;

    const dx = e.changedTouches[0].clientX - startX;

    if (Math.abs(dx) > 50) {
        if (dx > 0) {
            sendKey("keydown", "ArrowRight", "ArrowRight", 39);
            setTimeout(() =>
                sendKey("keyup", "ArrowRight", "ArrowRight", 39), 50);
        } else {
            sendKey("keydown", "ArrowLeft", "ArrowLeft", 37);
            setTimeout(() =>
                sendKey("keyup", "ArrowLeft", "ArrowLeft", 37), 50);
        }
    }

    startX = null;
}, { passive: false });

/* ========= BLOCK SCROLL ========= */
document.body.addEventListener("touchmove", e => e.preventDefault(), {
    passive: false
});
</script>

<!-- Optional -->
<script src="js/analytics_ubg_v1_4.js"></script>
<script src="js/redirect_v1_0.js"></script>

</body>
</html>
